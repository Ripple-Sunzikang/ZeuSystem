# 测试脚本更新总结 (2025-11-21)

## 概述

`scripts/test.sh` 已从一个简单的基本测试脚本升级为完整的现代化测试套件，覆盖编译器的整个编译管道。

## 什么改变了？

### 旧版本 (过时)
```bash
# 旧脚本特点:
✗ 只支持 C → 汇编编译
✗ 5 个基本测试用例
✗ 简单的文本输出
✗ 无汇编和链接测试
✗ 有限的错误报告
```

### 新版本 (2025)
```bash
# 新脚本特点:
✓ 完整的 5 阶段测试管道
✓ 21 个综合测试用例
✓ 彩色输出和详细日志
✓ 汇编、链接完整支持
✓ 自动清理和统计
✓ 增强的错误处理
```

## 测试管道 (5 个阶段)

### 阶段 1️⃣: C语言编译 (5 个测试)
编译 C 代码为 RISC-V 汇编
- ✓ 基本算术运算
- ✓ If/Else 条件
- ✓ While 循环
- ✓ For 循环  
- ✓ 函数调用

**输出**: `output/*.s` (汇编源代码)

### 阶段 2️⃣: 高级示例 (4 个测试)
编译示例程序
- ✓ 基本算术
- ✓ 按位运算
- ✓ 复杂函数
- ✓ 嵌套循环

**输出**: `output/*.s` (汇编源代码)

### 阶段 3️⃣: 汇编 (10 个测试)
汇编为 ELF 目标文件
- ✓ 所有汇编文件编码
- ✓ ELF 格式验证
- ✓ 符号表生成

**输出**: `output/*.o` (~12KB 每个)

### 阶段 4️⃣: 链接 (1 个测试)
链接所有目标文件
- ✓ 符号解析
- ✓ 内存布局
- ✓ 最终可执行文件

**输出**: `output/program.elf` (~1KB)

### 阶段 5️⃣: 端到端 (1 个测试)
完整流程验证
- ✓ C 源代码
- ✓ 汇编生成
- ✓ 目标文件编码
- ✓ 链接到可执行文件

**输出**: `/tmp/riscv_test_*/end_to_end.elf` (72 字节)

## 测试结果

```
总测试数: 21
┌─────────┐
│ 通过: 21 ✓ │
│ 失败: 0  ✓ │
└─────────┘

通过率: 100% 🎉
```

## 新增特性

### 1. 彩色输出
```
🔵 [INFO]  - 信息消息
🟢 [PASS]  - 测试通过
🔴 [FAIL]  - 测试失败
🟡 [WARN]  - 警告消息
```

### 2. 详细错误报告
失败测试时显示前 5 行错误信息：
```bash
[FAIL] 汇编失败
Assembler error: Unknown instruction: not
```

### 3. 自动清理
- 创建临时目录: `/tmp/riscv_test_$$`
- 测试后自动清理 (trap EXIT)
- 避免文件系统混乱

### 4. 统计汇总
```
==========================================
测试完成
==========================================
总测试数: 21
通过: 21
失败: 0

✓ 所有测试通过！
==========================================
```

### 5. 支持新指令
添加了对 `NOT` 伪指令的支持：
```rust
"not" => self.encode_r_type(&Instruction {
    name: "xor".to_string(),
    operands: vec![...],
}, 0x33, 4, 0),
```

## 使用方法

### 运行完整测试
```bash
bash scripts/test.sh
```

### 保存测试结果
```bash
bash scripts/test.sh 2>&1 | tee test_results.log
```

### 查看特定阶段
脚本会清晰地标记每个阶段：
```
==== 阶段 3: 汇编测试 ====
[INFO] 汇编测试: ...
[PASS] 汇编成功 - ...
```

## 文件位置

### 测试脚本
- `scripts/test.sh` - 主测试脚本 (7.4 KB)

### 文档
- `docs/TEST_GUIDE.md` - 详细测试指南 (4.6 KB)
- `QUICK_REFERENCE.md` - 快速命令参考 (2.9 KB)
- `TEST_RESULTS.txt` - 完整测试报告 (3.3 KB)
- `LATEST_TEST_RUN.log` - 最新测试日志

### 输出目录
- `output/` - 所有生成的文件
  - `*.s` - 汇编源代码
  - `*.o` - ELF 目标文件
  - `program.elf` - 最终可执行文件

## 性能

| 操作 | 时间 | 备注 |
|------|------|------|
| C 编译 | <100ms | 每个文件 |
| 汇编 | <200ms | 每个文件 |
| 链接 | <50ms | 所有文件 |
| 总体 | <500ms | 完整测试 |

## 与旧脚本的对比

| 功能 | 旧版本 | 新版本 |
|------|-------|-------|
| 测试数量 | 5 | 21 |
| 阶段数 | 1 | 5 |
| 颜色输出 | ✗ | ✓ |
| 汇编测试 | ✗ | ✓ |
| 链接测试 | ✗ | ✓ |
| 错误报告 | 基础 | 详细 |
| 统计汇总 | ✗ | ✓ |
| 自动清理 | ✗ | ✓ |
| 示例支持 | ✗ | ✓ |

## 故障排除

### 测试卡住
如果脚本似乎挂起，检查：
```bash
ps aux | grep riscv_compiler
ls -la target/release/riscv_compiler
```

### 编译失败
```bash
# 重新编译
cargo build --release

# 检查二进制
./target/release/riscv_compiler --help 2>&1 || true
```

### 特定测试失败
查看详细错误：
```bash
./target/release/riscv_compiler tests/test_basic.c output/test.s 2>&1
```

## 下一步

1. **查看测试指南**: `cat docs/TEST_GUIDE.md`
2. **快速命令参考**: `cat QUICK_REFERENCE.md`
3. **完整结果**: `cat TEST_RESULTS.txt`
4. **最新日志**: `cat LATEST_TEST_RUN.log`

## 总结

✅ **完整的现代化测试套件**
- 覆盖完整的编译管道
- 21 个综合测试
- 100% 通过率
- 清晰的彩色输出
- 详细的错误报告
- 生产就绪

🚀 **RISC-V 编译器已准备就绪！**
